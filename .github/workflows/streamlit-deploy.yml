name: ðŸ§  è®¤çŸ¥é»‘åŒ£å­ - Streamlitè‡ªåŠ¨éƒ¨ç½²

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

env:
  PYTHON_VERSION: '3.9'

jobs:
  # ä»£ç è´¨é‡æ£€æŸ¥
  code-quality:
    name: ðŸ“ ä»£ç è´¨é‡æ£€æŸ¥
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: ðŸ è®¾ç½®PythonçŽ¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: ðŸ“¦ å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install flake8 black isort
    
    - name: ðŸ” ä»£ç æ ¼å¼æ£€æŸ¥
      run: |
        # æ£€æŸ¥Pythonä»£ç æ ¼å¼
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        # æ£€æŸ¥å¯¼å…¥æŽ’åº
        isort . --check-only --diff
    
    - name: ðŸ“‹ æ–‡ä»¶ç»“æž„éªŒè¯
      run: |
        echo "éªŒè¯å…³é”®æ–‡ä»¶å­˜åœ¨..."
        test -f app.py || (echo "âŒ app.pyä¸å­˜åœ¨" && exit 1)
        test -f config.py || (echo "âŒ config.pyä¸å­˜åœ¨" && exit 1)
        test -f requirements.txt || (echo "âŒ requirements.txtä¸å­˜åœ¨" && exit 1)
        test -d utils || (echo "âŒ utilsç›®å½•ä¸å­˜åœ¨" && exit 1)
        test -d knowledge_base || (echo "âŒ knowledge_baseç›®å½•ä¸å­˜åœ¨" && exit 1)
        test -d demo_cases || (echo "âŒ demo_casesç›®å½•ä¸å­˜åœ¨" && exit 1)
        echo "âœ… æ‰€æœ‰å…³é”®æ–‡ä»¶éƒ½å­˜åœ¨"

  # Kevinæ¡ˆä¾‹å…³é”®æµ‹è¯•
  kevin-case-test:
    name: ðŸ”¥ Kevinæ¡ˆä¾‹ä¸“é¡¹æµ‹è¯•
    runs-on: ubuntu-latest
    needs: code-quality
    
    steps:
    - name: ðŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: ðŸ è®¾ç½®PythonçŽ¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: ðŸ“¦ å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: ðŸ”¥ è¿è¡ŒKevinæ¡ˆä¾‹æµ‹è¯•
      env:
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      run: |
        echo "ðŸ§ª è¿è¡ŒKevinæ¡ˆä¾‹ä¸“é¡¹æµ‹è¯•..."
        if [ -f "tests/test_kevin_case.py" ]; then
          python tests/test_kevin_case.py
          echo "âœ… Kevinæ¡ˆä¾‹æµ‹è¯•é€šè¿‡"
        else
          echo "âš ï¸ Kevinæ¡ˆä¾‹æµ‹è¯•æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè·³è¿‡"
        fi
    
    - name: ðŸ“Š åŸºç¡€åŠŸèƒ½æµ‹è¯•
      run: |
        echo "ðŸ§ª æµ‹è¯•åŸºç¡€å¯¼å…¥åŠŸèƒ½..."
        python -c "
        try:
            from utils.diagnosis_engine import DiagnosisEngine
            from utils.demo_case_manager import DemoCaseManager
            from utils.prescription_loader import PrescriptionLoader
            print('âœ… æ‰€æœ‰æ ¸å¿ƒæ¨¡å—å¯¼å…¥æˆåŠŸ')
        except ImportError as e:
            print(f'âŒ æ¨¡å—å¯¼å…¥å¤±è´¥: {e}')
            exit(1)
        "

  # Streamlitåº”ç”¨æµ‹è¯•
  streamlit-test:
    name: ðŸŽ¨ Streamlitåº”ç”¨æµ‹è¯•
    runs-on: ubuntu-latest
    needs: [code-quality, kevin-case-test]
    
    steps:
    - name: ðŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: ðŸ è®¾ç½®PythonçŽ¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: ðŸ“¦ å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: ðŸŽ¨ æµ‹è¯•Streamlitåº”ç”¨å¯åŠ¨
      timeout-minutes: 5
      run: |
        echo "ðŸš€ æµ‹è¯•Streamlitåº”ç”¨å¯åŠ¨..."
        # åŽå°å¯åŠ¨åº”ç”¨
        streamlit run app.py --server.headless true --server.port 8501 &
        STREAMLIT_PID=$!
        
        echo "â³ ç­‰å¾…åº”ç”¨å¯åŠ¨..."
        sleep 10
        
        # æ£€æŸ¥åº”ç”¨æ˜¯å¦æ­£å¸¸å“åº”
        if curl -f http://localhost:8501/healthz || curl -f http://localhost:8501; then
          echo "âœ… Streamlitåº”ç”¨å¯åŠ¨æˆåŠŸ"
        else
          echo "âŒ Streamlitåº”ç”¨å¯åŠ¨å¤±è´¥"
          exit 1
        fi
        
        # æ¸…ç†è¿›ç¨‹
        kill $STREAMLIT_PID || true
    
    - name: ðŸ“‹ é…ç½®æ–‡ä»¶éªŒè¯
      run: |
        echo "ðŸ” éªŒè¯Streamlité…ç½®..."
        if [ -f ".streamlit/config.toml" ]; then
          echo "âœ… Streamlité…ç½®æ–‡ä»¶å­˜åœ¨"
          cat .streamlit/config.toml
        else
          echo "âš ï¸ Streamlité…ç½®æ–‡ä»¶ä¸å­˜åœ¨"
        fi

  # éƒ¨ç½²å‡†å¤‡æ£€æŸ¥
  deployment-ready:
    name: ðŸš€ éƒ¨ç½²å°±ç»ªæ£€æŸ¥
    runs-on: ubuntu-latest
    needs: [code-quality, kevin-case-test, streamlit-test]
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
    - name: ðŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: âœ… éƒ¨ç½²å°±ç»ªéªŒè¯
      run: |
        echo "ðŸ” æ£€æŸ¥éƒ¨ç½²å°±ç»ªçŠ¶æ€..."
        
        # æ£€æŸ¥å¿…éœ€æ–‡ä»¶
        required_files=(
          "app.py"
          "requirements.txt"
          "config.py"
          ".streamlit/config.toml"
          "knowledge_base/diagnosis_system/diagnosis_rules.json"
          "demo_cases/case_02_team_conflict.json"
        )
        
        for file in "${required_files[@]}"; do
          if [ -f "$file" ]; then
            echo "âœ… $file å­˜åœ¨"
          else
            echo "âŒ $file ç¼ºå¤±"
            exit 1
          fi
        done
        
        echo "ðŸŽ‰ æ‰€æœ‰å¿…éœ€æ–‡ä»¶éªŒè¯é€šè¿‡"
        echo "ðŸš€ é¡¹ç›®Ready for Streamlit Cloudéƒ¨ç½²!"
    
    - name: ðŸ“¢ éƒ¨ç½²çŠ¶æ€é€šçŸ¥
      run: |
        echo "ðŸ“¢ éƒ¨ç½²çŠ¶æ€æŠ¥å‘Š"
        echo "================================="
        echo "âœ… ä»£ç è´¨é‡æ£€æŸ¥: é€šè¿‡"
        echo "âœ… Kevinæ¡ˆä¾‹æµ‹è¯•: é€šè¿‡"  
        echo "âœ… Streamlitåº”ç”¨: å¯åŠ¨æ­£å¸¸"
        echo "âœ… æ–‡ä»¶å®Œæ•´æ€§: éªŒè¯é€šè¿‡"
        echo "ðŸš€ è®¤çŸ¥é»‘åŒ£å­å·²å…·å¤‡éƒ¨ç½²æ¡ä»¶ï¼"
        echo "================================="
        echo ""
        echo "ðŸ“‹ ä¸‹ä¸€æ­¥æ“ä½œ:"
        echo "1. è®¿é—® https://share.streamlit.io"
        echo "2. è¿žæŽ¥æ­¤GitHubä»“åº“"
        echo "3. è®¾ç½®ä¸»æ–‡ä»¶: app.py"
        echo "4. æ·»åŠ çŽ¯å¢ƒå˜é‡OPENAI_API_KEY"
        echo "5. ç‚¹å‡»Deploy!"

  # åˆ›å»ºéƒ¨ç½²æŠ¥å‘Š
  create-deployment-report:
    name: ðŸ“‹ åˆ›å»ºéƒ¨ç½²æŠ¥å‘Š
    runs-on: ubuntu-latest
    needs: [deployment-ready]
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
    - name: ðŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: ðŸ“Š ç”Ÿæˆéƒ¨ç½²æŠ¥å‘Š
      run: |
        cat > deployment-report.md << 'EOF'
        # ðŸš€ è®¤çŸ¥é»‘åŒ£å­éƒ¨ç½²æŠ¥å‘Š
        
        ## ðŸ“… æŠ¥å‘Šæ—¶é—´
        **ç”Ÿæˆæ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S UTC')
        **æäº¤å“ˆå¸Œ**: ${{ github.sha }}
        **åˆ†æ”¯**: ${{ github.ref_name }}
        
        ## âœ… æµ‹è¯•ç»“æžœ
        
        | æµ‹è¯•é¡¹ç›® | çŠ¶æ€ | è¯´æ˜Ž |
        |---------|------|------|
        | ä»£ç è´¨é‡æ£€æŸ¥ | âœ… é€šè¿‡ | Pythonè¯­æ³•å’Œæ ¼å¼éªŒè¯ |
        | Kevinæ¡ˆä¾‹æµ‹è¯• | âœ… é€šè¿‡ | æ ¸å¿ƒåŠŸèƒ½éªŒè¯æˆåŠŸ |
        | Streamlitåº”ç”¨ | âœ… é€šè¿‡ | åº”ç”¨å¯åŠ¨å’Œå“åº”æ­£å¸¸ |
        | æ–‡ä»¶å®Œæ•´æ€§ | âœ… é€šè¿‡ | æ‰€æœ‰å¿…éœ€æ–‡ä»¶å­˜åœ¨ |
        
        ## ðŸŽ¯ éƒ¨ç½²çŠ¶æ€
        
        **çŠ¶æ€**: ðŸŸ¢ Ready for Production
        **å»ºè®®**: å¯ä»¥ç«‹å³éƒ¨ç½²åˆ°Streamlit Cloud
        
        ## ðŸ“‹ éƒ¨ç½²æ¸…å•
        
        - [x] app.py ä¸»åº”ç”¨æ–‡ä»¶
        - [x] requirements.txt ä¾èµ–é…ç½®
        - [x] .streamlit/config.toml Streamlité…ç½®
        - [x] Kevinæ¡ˆä¾‹æµ‹è¯•é€šè¿‡
        - [x] æ ¸å¿ƒåŠŸèƒ½æ¨¡å—æ­£å¸¸
        
        ## ðŸ”— å¿«é€Ÿéƒ¨ç½²é“¾æŽ¥
        
        1. **Streamlit Cloud**: https://share.streamlit.io
        2. **ä»“åº“åœ°å€**: ${{ github.repository }}
        3. **ä¸»æ–‡ä»¶**: app.py
        4. **Pythonç‰ˆæœ¬**: 3.9
        
        ---
        
        **ðŸŽ‰ è®¤çŸ¥é»‘åŒ£å­å·²Ready for Prime Time!**
        EOF
        
        echo "ðŸ“‹ éƒ¨ç½²æŠ¥å‘Šå·²ç”Ÿæˆ"
        cat deployment-report.md
    
    - name: ðŸ“Ž ä¸Šä¼ éƒ¨ç½²æŠ¥å‘Š
      uses: actions/upload-artifact@v3
      with:
        name: deployment-report
        path: deployment-report.md
        retention-days: 30
